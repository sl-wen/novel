# 前后端分离部署说明

## 🎯 部署架构

```
slwen.cn (Nginx反向代理)
├── / (React前端 - 端口3000)
├── /api/novels/* (小说API后端 - 端口8000)
├── /novel/* (小说API其他路径 - 端口8000)
└── /novel/health (健康检查)
```

## 📋 部署步骤

### 1. 确保React前端运行在端口3000

确保您的React应用配置为运行在端口3000：

```bash
# 在React项目目录中
npm start  # 默认运行在 http://localhost:3000
# 或者
yarn start
```

### 2. 确保小说API后端运行在端口8000

小说API已经配置为运行在端口8000，通过systemd服务管理：

```bash
# 检查服务状态
sudo systemctl status novel-api

# 启动服务
sudo systemctl start novel-api

# 查看日志
sudo journalctl -u novel-api -f
```

### 3. Nginx配置

Nginx配置已经更新，支持前后端分离：

- **React前端**: 所有根路径请求转发到端口3000
- **小说API**: `/api/novels/*` 和 `/novel/*` 路径转发到端口8000
- **静态资源**: 缓存优化

### 4. 测试部署

#### 测试React前端
```bash
curl https://slwen.cn/
# 应该返回React应用的HTML
```

#### 测试小说API
```bash
# 搜索API
curl "https://slwen.cn/api/novels/search?keyword=修真"

# 书源API
curl https://slwen.cn/api/novels/sources

# 健康检查
curl https://slwen.cn/novel/health
```

#### 测试API文档
```bash
curl https://slwen.cn/novel/docs
# 应该返回FastAPI的Swagger文档
```

## 🔧 故障排除

### 1. 检查服务状态

```bash
# 检查React前端
netstat -tlnp | grep 3000

# 检查小说API
sudo systemctl status novel-api
netstat -tlnp | grep 8000

# 检查Nginx
sudo systemctl status nginx
sudo nginx -t
```

### 2. 查看日志

```bash
# React前端日志（取决于您的启动方式）
# 如果使用PM2: pm2 logs
# 如果使用systemd: sudo journalctl -u react-app -f

# 小说API日志
sudo journalctl -u novel-api -f

# Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 3. 常见问题

#### 问题1: React应用无法访问
- 检查React应用是否在端口3000运行
- 检查防火墙是否允许端口3000

#### 问题2: 小说API返回404
- 检查novel-api服务是否启动
- 检查端口8000是否监听
- 检查Nginx配置是否正确

#### 问题3: 静态资源加载失败
- 检查React应用的静态资源路径
- 检查Nginx的静态资源缓存配置

## 🚀 自动化部署

使用GitHub Actions进行自动化部署：

1. **推送代码触发部署**:
   ```bash
   git add .
   git commit -m "更新前后端分离配置"
   git push origin main
   ```

2. **查看部署状态**:
   - 访问GitHub仓库的Actions页面
   - 查看部署日志和状态

3. **部署完成后测试**:
   - 测试React前端: https://slwen.cn/
   - 测试小说API: https://slwen.cn/api/novels/search?keyword=修真

## 📝 配置说明

### Nginx路由规则

1. **优先级顺序**:
   - `/api/novels/*` → 小说API (端口8000)
   - `/novel/*` → 小说API (端口8000)
   - 静态资源文件 → React前端 (端口3000)
   - 其他所有路径 → React前端 (端口3000)

2. **缓存策略**:
   - 静态资源: 1年缓存
   - 小说下载文件: 1天缓存
   - API响应: 不缓存

3. **超时设置**:
   - 小说API: 60秒超时
   - React前端: 默认超时

## 🔒 安全考虑

1. **防火墙配置**:
   - 只开放80和443端口
   - 内部端口3000和8000不对外暴露

2. **HTTPS配置**:
   - 建议配置SSL证书
   - 使用Let's Encrypt免费证书

3. **访问控制**:
   - 根据需要配置访问限制
   - 考虑添加API限流

## 📞 支持

如果遇到问题，请检查：
1. 服务状态和日志
2. 网络连接和防火墙
3. Nginx配置语法
4. 端口占用情况 