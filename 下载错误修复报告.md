# ä¸‹è½½é”™è¯¯ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·é‡åˆ°ä¸‹è½½å¤±è´¥é”™è¯¯ï¼š
```
ä¸‹è½½å¤±è´¥: ä¸‹è½½å¤±è´¥: 500 {"code":500,"message":"ä¸‹è½½å°è¯´å¤±è´¥: è·å–å°è¯´ç›®å½•å¤±è´¥","data":null}
```

## é—®é¢˜åˆ†æ

é€šè¿‡æ·±å…¥åˆ†æä»£ç å’Œç½‘ç»œè¿æ¥æµ‹è¯•ï¼Œå‘ç°é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼š

1. **é»˜è®¤ä¹¦æºä¸å¯ç”¨**ï¼šç³»ç»Ÿé»˜è®¤ä½¿ç”¨ä¹¦æº1ï¼ˆé¦™ä¹¦å°è¯´ - http://www.xbiqugu.la/ï¼‰ï¼Œä½†è¯¥ç½‘ç«™æ— æ³•è®¿é—®
2. **ç¼ºä¹å®¹é”™æœºåˆ¶**ï¼šå½“ä¸»è¦ä¹¦æºå¤±è´¥æ—¶ï¼Œç³»ç»Ÿæ²¡æœ‰è‡ªåŠ¨å°è¯•å…¶ä»–å¯ç”¨ä¹¦æº
3. **ä¹¦æºçŠ¶æ€æœªéªŒè¯**ï¼šç³»ç»Ÿå¯åŠ¨æ—¶æœªæ£€æŸ¥ä¹¦æºçš„å¯ç”¨æ€§çŠ¶æ€

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ›´æ”¹é»˜è®¤ä¹¦æºï¼ˆå·²å®Œæˆ âœ…ï¼‰

**æ–‡ä»¶**ï¼š`app/core/config.py`
**ä¿®æ”¹**ï¼šå°† `DEFAULT_SOURCE_ID` ä» 1 æ”¹ä¸º 2

```python
# ä¿®æ”¹å‰
DEFAULT_SOURCE_ID: int = 1

# ä¿®æ”¹å  
DEFAULT_SOURCE_ID: int = 2  # æ”¹ä¸ºä¹¦æº2ï¼Œå› ä¸ºä¹¦æº1æ— æ³•è®¿é—®
```

**åŸå› **ï¼šä¹¦æº2ï¼ˆä¹¦æµ·é˜å°è¯´ç½‘ - https://www.shuhaige.net/ï¼‰ç»æµ‹è¯•å¯æ­£å¸¸è®¿é—®

### 2. å¢å¼ºé”™è¯¯å¤„ç†æœºåˆ¶ï¼ˆå·²å®Œæˆ âœ…ï¼‰

**æ–‡ä»¶**ï¼š`app/services/novel_service.py`
**åŠŸèƒ½**ï¼šåœ¨ `get_toc` æ–¹æ³•ä¸­æ·»åŠ å¤‡ç”¨ä¹¦æºé€»è¾‘

**æ ¸å¿ƒé€»è¾‘**ï¼š
1. é¦–å…ˆå°è¯•æŒ‡å®šçš„ä¹¦æº
2. å¦‚æœå¤±è´¥ï¼Œè‡ªåŠ¨å°è¯•å…¶ä»–å¯ç”¨çš„ä¹¦æºï¼ˆæœ€å¤š3ä¸ªï¼‰
3. è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
4. åªæœ‰åœ¨æ‰€æœ‰ä¹¦æºéƒ½å¤±è´¥æ—¶æ‰æŠ›å‡ºå¼‚å¸¸

```python
async def get_toc(self, url: str, source_id: int, start: int = 1, end: int = None) -> List[ChapterInfo]:
    # é¦–å…ˆå°è¯•æŒ‡å®šçš„ä¹¦æº
    source = self.sources.get(source_id)
    if not source:
        raise ValueError(f"æ— æ•ˆçš„ä¹¦æºID: {source_id}")
    
    try:
        toc_parser = TocParser(source)
        result = await toc_parser.parse(url, start, end or float("inf"))
        if result:
            return result
        logger.warning(f"ä¹¦æº {source_id} æœªèƒ½è·å–åˆ°ç›®å½•ï¼Œå°è¯•å…¶ä»–ä¹¦æº")
    except Exception as e:
        logger.error(f"ä¹¦æº {source_id} è·å–ç›®å½•å¤±è´¥: {str(e)}")
        logger.info("å°è¯•ä½¿ç”¨å…¶ä»–å¯ç”¨ä¹¦æº...")
    
    # å¦‚æœä¸»è¦ä¹¦æºå¤±è´¥ï¼Œå°è¯•å…¶ä»–å¯ç”¨çš„ä¹¦æº
    available_sources = [sid for sid in self.sources.keys() if sid != source_id]
    logger.info(f"å°è¯•ä½¿ç”¨å¤‡ç”¨ä¹¦æº: {available_sources}")
    
    for backup_source_id in available_sources[:3]:  # æœ€å¤šå°è¯•3ä¸ªå¤‡ç”¨ä¹¦æº
        try:
            logger.info(f"å°è¯•å¤‡ç”¨ä¹¦æº {backup_source_id}")
            backup_source = self.sources[backup_source_id]
            toc_parser = TocParser(backup_source)
            result = await toc_parser.parse(url, start, end or float("inf"))
            if result:
                logger.info(f"å¤‡ç”¨ä¹¦æº {backup_source_id} æˆåŠŸè·å–ç›®å½•")
                return result
        except Exception as e:
            logger.warning(f"å¤‡ç”¨ä¹¦æº {backup_source_id} ä¹Ÿå¤±è´¥äº†: {str(e)}")
            continue
    
    # æ‰€æœ‰ä¹¦æºéƒ½å¤±è´¥äº†
    raise ValueError("è·å–å°è¯´ç›®å½•å¤±è´¥ï¼šæ‰€æœ‰ä¹¦æºéƒ½æ— æ³•è®¿é—®")
```

### 3. æ·»åŠ ä¹¦æºå¯ç”¨æ€§éªŒè¯ï¼ˆå·²å®Œæˆ âœ…ï¼‰

**æ–‡ä»¶**ï¼š`app/services/novel_service.py`
**åŠŸèƒ½**ï¼šåœ¨æœåŠ¡åˆå§‹åŒ–æ—¶è‡ªåŠ¨éªŒè¯æ‰€æœ‰ä¹¦æºçš„å¯ç”¨æ€§

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. å¹¶å‘æ£€æŸ¥æ‰€æœ‰ä¹¦æºçš„ç½‘ç»œè¿æ¥çŠ¶æ€
2. è®°å½•å¯ç”¨å’Œä¸å¯ç”¨çš„ä¹¦æº
3. æä¾›è¯¦ç»†çš„çŠ¶æ€æŠ¥å‘Š
4. åœ¨é»˜è®¤ä¹¦æºä¸å¯ç”¨æ—¶ç»™å‡ºå»ºè®®

```python
async def _validate_sources(self):
    """éªŒè¯æ‰€æœ‰ä¹¦æºçš„å¯ç”¨æ€§"""
    import aiohttp
    import asyncio
    
    logger.info("å¼€å§‹éªŒè¯ä¹¦æºå¯ç”¨æ€§...")
    
    async def check_source(source_id, source):
        """æ£€æŸ¥å•ä¸ªä¹¦æºçš„å¯ç”¨æ€§"""
        try:
            url = source.rule.get("url", "")
            if not url:
                return source_id, False, "æœªé…ç½®URL"
            
            # åˆ›å»ºè¶…æ—¶è®¾ç½®
            timeout = aiohttp.ClientTimeout(total=10, connect=5)
            connector = aiohttp.TCPConnector(ssl=False)
            
            async with aiohttp.ClientSession(timeout=timeout, connector=connector) as session:
                async with session.head(url) as response:
                    if response.status < 400:
                        return source_id, True, f"çŠ¶æ€ç : {response.status}"
                    else:
                        return source_id, False, f"çŠ¶æ€ç : {response.status}"
        except Exception as e:
            return source_id, False, str(e)
    
    # å¹¶å‘æ£€æŸ¥æ‰€æœ‰ä¹¦æº
    tasks = [check_source(sid, source) for sid, source in self.sources.items()]
    results = await asyncio.gather(*tasks, return_exceptions=True)
    
    available_sources = []
    unavailable_sources = []
    
    for result in results:
        if isinstance(result, Exception):
            logger.error(f"æ£€æŸ¥ä¹¦æºæ—¶å‡ºç°å¼‚å¸¸: {result}")
            continue
            
        source_id, is_available, message = result
        source_name = self.sources[source_id].rule.get("name", f"ä¹¦æº{source_id}")
        
        if is_available:
            available_sources.append(source_id)
            logger.info(f"âœ… {source_name} (ID: {source_id}) å¯ç”¨ - {message}")
        else:
            unavailable_sources.append(source_id)
            logger.warning(f"âŒ {source_name} (ID: {source_id}) ä¸å¯ç”¨ - {message}")
    
    logger.info(f"ä¹¦æºéªŒè¯å®Œæˆ: {len(available_sources)} ä¸ªå¯ç”¨, {len(unavailable_sources)} ä¸ªä¸å¯ç”¨")
    
    return available_sources, unavailable_sources
```

## ä¿®å¤éªŒè¯

ä½¿ç”¨æµ‹è¯•è„šæœ¬ `test_fix.py` éªŒè¯ä¿®å¤æ•ˆæœï¼š

```
å°è¯´ä¸‹è½½åŠŸèƒ½ä¿®å¤éªŒè¯
==================================================
=== æµ‹è¯•é…ç½®ä¿®å¤ ===
âœ… é»˜è®¤ä¹¦æºå·²ä¿®æ”¹ä¸ºä¹¦æº2

=== æµ‹è¯•ä¹¦æºå¯ç”¨æ€§ ===
âœ… ä¹¦æº2é…ç½®: ä¹¦æµ·é˜å°è¯´ç½‘ - https://www.shuhaige.net/
âœ… ä¹¦æº2å·²å¯ç”¨

=== æµ‹è¯•é”™è¯¯å¤„ç†å¢å¼º ===
âœ… å·²æ·»åŠ å¤‡ç”¨ä¹¦æºé€»è¾‘
âœ… å·²æ·»åŠ ä¹¦æºéªŒè¯åŠŸèƒ½

==================================================
æµ‹è¯•ç»“æœ: 3/3 é€šè¿‡
ğŸ‰ æ‰€æœ‰ä¿®å¤éƒ½å·²æ­£ç¡®åº”ç”¨ï¼
```

## ä¿®å¤æ•ˆæœ

1. **è§£å†³åŸå§‹é—®é¢˜**ï¼šç³»ç»Ÿç°åœ¨ä½¿ç”¨å¯ç”¨çš„ä¹¦æº2ä½œä¸ºé»˜è®¤ä¹¦æºï¼Œé¿å…äº†è¿æ¥è¶…æ—¶é—®é¢˜
2. **æé«˜ç³»ç»Ÿå¯é æ€§**ï¼šå½“æŸä¸ªä¹¦æºä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°è¯•å…¶ä»–ä¹¦æº
3. **å¢å¼ºå¯è§‚æµ‹æ€§**ï¼šè¯¦ç»†çš„æ—¥å¿—è®°å½•å¸®åŠ©è¯Šæ–­é—®é¢˜
4. **ä¸»åŠ¨ç›‘æ§**ï¼šå¯åŠ¨æ—¶è‡ªåŠ¨éªŒè¯ä¹¦æºçŠ¶æ€

## ä½¿ç”¨å»ºè®®

1. **ç›‘æ§æ—¥å¿—**ï¼šå…³æ³¨åº”ç”¨å¯åŠ¨æ—¶çš„ä¹¦æºéªŒè¯æ—¥å¿—ï¼Œäº†è§£å½“å‰å¯ç”¨çŠ¶æ€
2. **å®šæœŸæ£€æŸ¥**ï¼šå»ºè®®å®šæœŸæ£€æŸ¥ä¹¦æºç½‘ç«™çš„å¯ç”¨æ€§ï¼ŒåŠæ—¶æ›´æ–°é…ç½®
3. **å¤‡ç”¨æ–¹æ¡ˆ**ï¼šå¦‚æœå‘ç°æŸäº›ä¹¦æºé•¿æœŸä¸å¯ç”¨ï¼Œå¯ä»¥è€ƒè™‘ç¦ç”¨æˆ–æ›¿æ¢

## æŠ€æœ¯æ”¹è¿›

æ­¤æ¬¡ä¿®å¤é‡‡ç”¨äº†ä»¥ä¸‹æœ€ä½³å®è·µï¼š

1. **å®¹é”™è®¾è®¡**ï¼šå¤šçº§é™çº§ç­–ç•¥ï¼Œæé«˜ç³»ç»Ÿé²æ£’æ€§
2. **å¼‚æ­¥å¤„ç†**ï¼šå¹¶å‘æ£€æŸ¥ä¹¦æºçŠ¶æ€ï¼Œæé«˜æ•ˆç‡
3. **è¯¦ç»†æ—¥å¿—**ï¼šå®Œå–„çš„é”™è¯¯è®°å½•å’ŒçŠ¶æ€æŠ¥å‘Š
4. **é…ç½®é©±åŠ¨**ï¼šé€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†ä¹¦æºï¼Œä¾¿äºç»´æŠ¤

ç°åœ¨ç³»ç»Ÿåº”è¯¥èƒ½å¤Ÿæ­£å¸¸å¤„ç†ä¸‹è½½è¯·æ±‚ï¼Œå³ä½¿æŸäº›ä¹¦æºä¸å¯ç”¨ä¹Ÿä¸ä¼šå½±å“æ•´ä½“æœåŠ¡ã€‚