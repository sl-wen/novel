# 章节标题格式化功能使用说明

## 功能简介

本功能专门解决从鸟书网等书源下载的小说缺少"第几章"这样的章节目录结构的问题。系统会自动检测章节标题格式，并为缺少序号的章节添加"第X章"格式。

## 功能特性

1. **自动检测**: 系统会自动分析章节标题格式，智能判断是否需要添加序号
2. **鸟书网特殊处理**: 对鸟书网自动启用章节序号添加功能
3. **可自定义格式**: 支持自定义章节序号的前缀和后缀
4. **用户控制**: 用户可以手动控制是否添加章节序号

## API参数说明

### 同步下载 API: `GET /api/optimized/download`

新增参数：
- `addChapterNumbers` (可选): 是否添加章节序号，默认自动检测
  - `true`: 强制添加章节序号
  - `false`: 不添加章节序号
  - `null` 或不传: 自动检测（推荐）

- `chapterPrefix` (可选): 章节序号前缀，默认"第"
- `chapterSuffix` (可选): 章节序号后缀，默认"章"

### 异步下载 API: `POST /api/optimized/download/start`

参数与同步下载API相同。

## 使用示例

### 1. 自动检测模式（推荐）

```bash
# 下载鸟书网小说，系统会自动添加章节序号
curl "http://localhost:8000/api/optimized/download?url=http://www.99xs.info/book/12345&sourceId=4"
```

### 2. 强制添加章节序号

```bash
# 强制为所有章节添加"第X章"格式
curl "http://localhost:8000/api/optimized/download?url=http://example.com/book/12345&sourceId=1&addChapterNumbers=true"
```

### 3. 自定义章节格式

```bash
# 使用"Chapter X"格式
curl "http://localhost:8000/api/optimized/download?url=http://example.com/book/12345&sourceId=1&addChapterNumbers=true&chapterPrefix=Chapter%20&chapterSuffix="

# 使用"第X话"格式
curl "http://localhost:8000/api/optimized/download?url=http://example.com/book/12345&sourceId=1&addChapterNumbers=true&chapterPrefix=第&chapterSuffix=话"
```

### 4. 禁用章节序号添加

```bash
# 即使是鸟书网也不添加章节序号
curl "http://localhost:8000/api/optimized/download?url=http://www.99xs.info/book/12345&sourceId=4&addChapterNumbers=false"
```

## 格式化效果示例

### 原始标题
```
- 开始的冒险
- 遇见伙伴
- 第一次战斗
- 获得力量
```

### 格式化后（第X章格式）
```
- 第1章 开始的冒险
- 第2章 遇见伙伴
- 第3章 第一次战斗
- 第4章 获得力量
```

### 自定义格式（Chapter X）
```
- Chapter 1 开始的冒险
- Chapter 2 遇见伙伴
- Chapter 3 第一次战斗
- Chapter 4 获得力量
```

## 智能检测规则

系统会检测以下章节标题模式：
- 第X章 (中文数字或阿拉伯数字)
- 第X话/第X节
- Chapter X
- X. (数字+点)
- (X) (括号数字)
- 【X】(方括号数字)

如果50%以上的章节已经有这些格式，系统不会添加额外的序号。

## 特殊处理

### 鸟书网自动处理
- 系统检测到鸟书网(sourceId=4)时，会自动启用章节序号添加
- 这是因为鸟书网的章节通常缺少"第几章"这样的标题结构
- 用户仍可以通过`addChapterNumbers=false`来禁用此功能

### 内容格式化
- 格式化后的章节标题会同时应用到：
  - 下载文件中的章节标题
  - 章节内容开头的标题行
  - EPUB文件的目录结构

## 注意事项

1. **URL编码**: 在URL中使用中文字符时，需要进行URL编码
2. **兼容性**: 此功能不会影响已有的下载流程，只是增强了章节标题格式
3. **性能**: 格式化处理对下载性能影响极小
4. **文件大小**: 添加章节标题可能会略微增加文件大小

## 常见问题

### Q: 为什么有些章节没有被格式化？
A: 如果章节标题已经包含序号格式（如"第1章"），系统不会重复添加。

### Q: 可以修改已下载文件的章节标题吗？
A: 需要重新下载。建议在下载时就设置好格式化选项。

### Q: 支持其他语言的章节格式吗？
A: 目前主要支持中文和英文格式，可以通过自定义前缀后缀实现其他格式。

### Q: 格式化会影响原始内容吗？
A: 不会。只会在章节标题和内容开头添加格式化的标题，不会修改正文内容。