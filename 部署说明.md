# 小说搜索下载API部署说明

## 📋 项目概述

这是一个基于FastAPI的小说搜索下载后端API，支持多书源搜索、小说详情获取、目录解析和多格式下载（TXT、EPUB、PDF）。

## 🚀 部署方式

### 方式一：GitHub Actions自动部署（推荐）

#### 1. 配置GitHub Secrets

在GitHub仓库设置中添加以下Secrets：

```
HOST: 服务器IP地址
USERNAME: SSH用户名
SSH_KEY: SSH私钥
PORT: SSH端口（默认22）
```

#### 2. 推送代码触发部署

```bash
git add .
git commit -m "部署配置"
git push origin main
```

GitHub Actions会自动：
- 运行测试
- 部署到服务器
- 配置Nginx
- 启动服务

### 方式二：手动部署

#### 1. 服务器环境要求

- Ubuntu 20.04+ / CentOS 8+
- Python 3.11+
- Nginx
- Git

#### 2. 安装系统依赖

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y python3 python3-pip python3-venv nginx git curl

# CentOS/RHEL
sudo yum update
sudo yum install -y python3 python3-pip nginx git curl
```

#### 3. 克隆项目

```bash
cd /var/www
sudo git clone https://github.com/your-username/novel-api.git
sudo chown -R $USER:$USER novel-api
cd novel-api
```

#### 4. 安装Python依赖

```bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

#### 5. 创建必要目录

```bash
mkdir -p downloads logs
```

#### 6. 配置systemd服务

```bash
sudo tee /etc/systemd/system/novel-api.service > /dev/null <<EOF
[Unit]
Description=Novel Search API
After=network.target

[Service]
Type=simple
User=$USER
Group=$USER
WorkingDirectory=/var/www/novel-api
Environment=PATH=/var/www/novel-api/venv/bin
ExecStart=/var/www/novel-api/venv/bin/python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl start novel-api
sudo systemctl enable novel-api
```

#### 7. 配置Nginx

```bash
sudo tee /etc/nginx/sites-available/novel-api > /dev/null <<EOF
server {
    listen 80;
    server_name your-domain.com;  # 替换为您的域名
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        
        # 支持大文件下载
        proxy_max_temp_file_size 0;
        proxy_buffering off;
        proxy_request_buffering off;
    }
}
EOF

sudo ln -sf /etc/nginx/sites-available/novel-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 方式三：Docker部署

#### 1. 安装Docker和Docker Compose

```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

#### 2. 启动服务

```bash
docker-compose up -d
```

## 🔧 配置说明

### 环境变量

可以在部署时设置以下环境变量：

```bash
# 基础配置
DEBUG=false
HOST=0.0.0.0
PORT=8000

# 安全配置
SECRET_KEY=your-secret-key-here

# 文件路径
DOWNLOAD_PATH=/var/www/novel-api/downloads

# 并发配置
MAX_CONCURRENT_REQUESTS=50
REQUEST_TIMEOUT=30
```

### 书源配置

书源配置文件位于 `resources/rule/new/` 目录下，每个书源一个JSON文件。

## 📊 监控和维护

### 查看服务状态

```bash
# systemd服务
sudo systemctl status novel-api

# Docker服务
docker-compose ps
```

### 查看日志

```bash
# systemd日志
sudo journalctl -u novel-api -f

# Docker日志
docker-compose logs -f novel-api
```

### 重启服务

```bash
# systemd服务
sudo systemctl restart novel-api

# Docker服务
docker-compose restart
```

## 🔍 健康检查

API提供健康检查端点：

```bash
curl http://your-domain.com/
```

返回状态码200表示服务正常。

## 📈 性能优化

### 1. 启用Gzip压缩

Nginx配置中已包含Gzip压缩配置。

### 2. 静态文件缓存

下载文件已配置1天缓存。

### 3. 连接池优化

API使用aiohttp连接池，支持并发请求。

## 🛡️ 安全建议

### 1. 防火墙配置

```bash
# 只开放必要端口
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS
sudo ufw enable
```

### 2. SSL证书

建议使用Let's Encrypt配置HTTPS：

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

### 3. 访问控制

可以在Nginx配置中添加IP白名单：

```nginx
allow 192.168.1.0/24;
deny all;
```

## 🐛 故障排除

### 常见问题

1. **服务启动失败**
   - 检查端口是否被占用：`netstat -tlnp | grep 8000`
   - 查看错误日志：`sudo journalctl -u novel-api -n 50`

2. **下载文件失败**
   - 检查磁盘空间：`df -h`
   - 检查目录权限：`ls -la /var/www/novel-api/downloads`

3. **搜索无结果**
   - 检查书源配置是否正确
   - 查看网络连接是否正常

### 调试模式

临时启用调试模式：

```bash
# 修改配置
export DEBUG=true

# 重启服务
sudo systemctl restart novel-api
```

## 📞 支持

如有问题，请：

1. 查看日志文件
2. 检查配置文件
3. 提交Issue到GitHub仓库

---

**部署完成后，API将在以下地址可用：**
- 本地访问：http://localhost:8000
- 域名访问：http://your-domain.com
- API文档：http://your-domain.com/docs 