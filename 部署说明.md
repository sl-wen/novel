# å°è¯´æœç´¢ä¸‹è½½APIéƒ¨ç½²è¯´æ˜Ž

## ðŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºŽFastAPIçš„å°è¯´æœç´¢ä¸‹è½½åŽç«¯APIï¼Œæ”¯æŒå¤šä¹¦æºæœç´¢ã€å°è¯´è¯¦æƒ…èŽ·å–ã€ç›®å½•è§£æžå’Œå¤šæ ¼å¼ä¸‹è½½ï¼ˆTXTã€EPUBã€PDFï¼‰ã€‚

## ðŸš€ éƒ¨ç½²æ–¹å¼

### æ–¹å¼ä¸€ï¼šGitHub Actionsè‡ªåŠ¨éƒ¨ç½²ï¼ˆæŽ¨èï¼‰

#### 1. é…ç½®GitHub Secrets

åœ¨GitHubä»“åº“è®¾ç½®ä¸­æ·»åŠ ä»¥ä¸‹Secretsï¼š

```
HOST: æœåŠ¡å™¨IPåœ°å€
USERNAME: SSHç”¨æˆ·å
SSH_KEY: SSHç§é’¥
PORT: SSHç«¯å£ï¼ˆé»˜è®¤22ï¼‰
```

#### 2. æŽ¨é€ä»£ç è§¦å‘éƒ¨ç½²

```bash
git add .
git commit -m "éƒ¨ç½²é…ç½®"
git push origin main
```

GitHub Actionsä¼šè‡ªåŠ¨ï¼š
- è¿è¡Œæµ‹è¯•
- éƒ¨ç½²åˆ°æœåŠ¡å™¨
- é…ç½®Nginx
- å¯åŠ¨æœåŠ¡

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²

#### 1. æœåŠ¡å™¨çŽ¯å¢ƒè¦æ±‚

- Ubuntu 20.04+ / CentOS 8+
- Python 3.11+
- Nginx
- Git

#### 2. å®‰è£…ç³»ç»Ÿä¾èµ–

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y python3 python3-pip python3-venv nginx git curl

# CentOS/RHEL
sudo yum update
sudo yum install -y python3 python3-pip nginx git curl
```

#### 3. å…‹éš†é¡¹ç›®

```bash
cd /var/www
sudo git clone https://github.com/your-username/novel-api.git
sudo chown -R $USER:$USER novel-api
cd novel-api
```

#### 4. å®‰è£…Pythonä¾èµ–

```bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

#### 5. åˆ›å»ºå¿…è¦ç›®å½•

```bash
mkdir -p downloads logs
```

#### 6. é…ç½®systemdæœåŠ¡

```bash
sudo tee /etc/systemd/system/novel-api.service > /dev/null <<EOF
[Unit]
Description=Novel Search API
After=network.target

[Service]
Type=simple
User=$USER
Group=$USER
WorkingDirectory=/var/www/novel-api
Environment=PATH=/var/www/novel-api/venv/bin
ExecStart=/var/www/novel-api/venv/bin/python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl start novel-api
sudo systemctl enable novel-api
```

#### 7. é…ç½®Nginx

```bash
sudo tee /etc/nginx/sites-available/novel-api > /dev/null <<EOF
server {
    listen 80;
    server_name your-domain.com;  # æ›¿æ¢ä¸ºæ‚¨çš„åŸŸå
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        
        # æ”¯æŒå¤§æ–‡ä»¶ä¸‹è½½
        proxy_max_temp_file_size 0;
        proxy_buffering off;
        proxy_request_buffering off;
    }
}
EOF

sudo ln -sf /etc/nginx/sites-available/novel-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### æ–¹å¼ä¸‰ï¼šDockeréƒ¨ç½²

#### 1. å®‰è£…Dockerå’ŒDocker Compose

```bash
# å®‰è£…Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# å®‰è£…Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

#### 2. å¯åŠ¨æœåŠ¡

```bash
docker-compose up -d
```

## ðŸ”§ é…ç½®è¯´æ˜Ž

### çŽ¯å¢ƒå˜é‡

å¯ä»¥åœ¨éƒ¨ç½²æ—¶è®¾ç½®ä»¥ä¸‹çŽ¯å¢ƒå˜é‡ï¼š

```bash
# åŸºç¡€é…ç½®
DEBUG=false
HOST=0.0.0.0
PORT=8000

# å®‰å…¨é…ç½®
SECRET_KEY=your-secret-key-here

# æ–‡ä»¶è·¯å¾„
DOWNLOAD_PATH=/var/www/novel-api/downloads

# å¹¶å‘é…ç½®
MAX_CONCURRENT_REQUESTS=50
REQUEST_TIMEOUT=30
```

### ä¹¦æºé…ç½®

ä¹¦æºé…ç½®æ–‡ä»¶ä½äºŽ `resources/rule/new/` ç›®å½•ä¸‹ï¼Œæ¯ä¸ªä¹¦æºä¸€ä¸ªJSONæ–‡ä»¶ã€‚

## ðŸ“Š ç›‘æŽ§å’Œç»´æŠ¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
# systemdæœåŠ¡
sudo systemctl status novel-api

# DockeræœåŠ¡
docker-compose ps
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# systemdæ—¥å¿—
sudo journalctl -u novel-api -f

# Dockeræ—¥å¿—
docker-compose logs -f novel-api
```

### é‡å¯æœåŠ¡

```bash
# systemdæœåŠ¡
sudo systemctl restart novel-api

# DockeræœåŠ¡
docker-compose restart
```

## ðŸ” å¥åº·æ£€æŸ¥

APIæä¾›å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š

```bash
curl http://your-domain.com/
```

è¿”å›žçŠ¶æ€ç 200è¡¨ç¤ºæœåŠ¡æ­£å¸¸ã€‚

## ðŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å¯ç”¨GzipåŽ‹ç¼©

Nginxé…ç½®ä¸­å·²åŒ…å«GzipåŽ‹ç¼©é…ç½®ã€‚

### 2. é™æ€æ–‡ä»¶ç¼“å­˜

ä¸‹è½½æ–‡ä»¶å·²é…ç½®1å¤©ç¼“å­˜ã€‚

### 3. è¿žæŽ¥æ± ä¼˜åŒ–

APIä½¿ç”¨aiohttpè¿žæŽ¥æ± ï¼Œæ”¯æŒå¹¶å‘è¯·æ±‚ã€‚

## ðŸ›¡ï¸ å®‰å…¨å»ºè®®

### 1. é˜²ç«å¢™é…ç½®

```bash
# åªå¼€æ”¾å¿…è¦ç«¯å£
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS
sudo ufw enable
```

### 2. SSLè¯ä¹¦

å»ºè®®ä½¿ç”¨Let's Encrypté…ç½®HTTPSï¼š

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

### 3. è®¿é—®æŽ§åˆ¶

å¯ä»¥åœ¨Nginxé…ç½®ä¸­æ·»åŠ IPç™½åå•ï¼š

```nginx
allow 192.168.1.0/24;
deny all;
```

## ðŸ› æ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜

1. **æœåŠ¡å¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š`netstat -tlnp | grep 8000`
   - æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼š`sudo journalctl -u novel-api -n 50`

2. **ä¸‹è½½æ–‡ä»¶å¤±è´¥**
   - æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼š`df -h`
   - æ£€æŸ¥ç›®å½•æƒé™ï¼š`ls -la /var/www/novel-api/downloads`

3. **æœç´¢æ— ç»“æžœ**
   - æ£€æŸ¥ä¹¦æºé…ç½®æ˜¯å¦æ­£ç¡®
   - æŸ¥çœ‹ç½‘ç»œè¿žæŽ¥æ˜¯å¦æ­£å¸¸

### è°ƒè¯•æ¨¡å¼

ä¸´æ—¶å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼š

```bash
# ä¿®æ”¹é…ç½®
export DEBUG=true

# é‡å¯æœåŠ¡
sudo systemctl restart novel-api
```

## ðŸ“ž æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
2. æ£€æŸ¥é…ç½®æ–‡ä»¶
3. æäº¤Issueåˆ°GitHubä»“åº“

---

**éƒ¨ç½²å®ŒæˆåŽï¼ŒAPIå°†åœ¨ä»¥ä¸‹åœ°å€å¯ç”¨ï¼š**
- æœ¬åœ°è®¿é—®ï¼šhttp://localhost:8000
- åŸŸåè®¿é—®ï¼šhttp://your-domain.com
- APIæ–‡æ¡£ï¼šhttp://your-domain.com/docs 