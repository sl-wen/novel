# 网络查询失败解决方案

## 问题诊断结果

经过详细检查，您遇到的"连续查询失败"问题主要由以下原因造成：

### 1. 主要问题：URL编码问题
- **根本原因**：中文字符在URL中未正确编码，导致HTTP请求格式错误
- **错误现象**：服务器返回"Invalid HTTP request received"
- **影响范围**：所有包含中文关键词的搜索请求

### 2. 网络连接状态
✅ **基础网络连接正常**：
- 外网连接测试通过（Google.com 可达）
- HTTP/HTTPS 请求正常
- DNS 解析功能正常

✅ **API服务运行正常**：
- 服务在端口8000正常运行
- 基础API端点响应正常
- 健康检查状态为"warning"（80分）

## 解决方案

### 方案1：客户端URL编码（推荐）

**JavaScript/前端解决方案：**
```javascript
// 正确的API调用方式
function searchNovels(keyword, maxResults = 30) {
    // 对中文关键词进行URL编码
    const encodedKeyword = encodeURIComponent(keyword);
    const url = `http://localhost:8000/api/novels/search?keyword=${encodedKeyword}&maxResults=${maxResults}`;
    
    return fetch(url)
        .then(response => response.json())
        .catch(error => {
            console.error('搜索失败:', error);
            throw error;
        });
}

// 使用示例
searchNovels('斗破苍穹', 5)
    .then(data => console.log('搜索结果:', data))
    .catch(error => console.error('错误:', error));
```

**Python客户端解决方案：**
```python
import urllib.parse
import requests

def search_novels(keyword, max_results=30):
    # 对中文关键词进行URL编码
    encoded_keyword = urllib.parse.quote(keyword)
    url = f"http://localhost:8000/api/novels/search?keyword={encoded_keyword}&maxResults={max_results}"
    
    try:
        response = requests.get(url)
        return response.json()
    except requests.RequestException as error:
        print(f'搜索失败: {error}')
        raise

# 使用示例
try:
    result = search_novels('斗破苍穹', 5)
    print('搜索结果:', result)
except Exception as error:
    print('错误:', error)
```

**curl命令行解决方案：**
```bash
# 错误的方式（会导致查询失败）
curl "http://localhost:8000/api/novels/search?keyword=斗破苍穹&maxResults=5"

# 正确的方式（URL编码后）
curl "http://localhost:8000/api/novels/search?keyword=%E6%96%97%E7%A0%B4%E8%8B%8D%E7%A9%B9&maxResults=5"

# 或者使用curl的自动编码功能
curl -G "http://localhost:8000/api/novels/search" \
  --data-urlencode "keyword=斗破苍穹" \
  --data-urlencode "maxResults=5"
```

### 方案2：服务端容错增强

如果需要在服务端增加对未编码中文的容错处理，可以修改API端点：

```python
# 在 app/api/endpoints/novels.py 中添加
from urllib.parse import unquote

@router.get("/search")
async def search_novels(keyword: str, maxResults: int = 30):
    try:
        # 尝试解码可能已编码的关键词
        decoded_keyword = unquote(keyword)
        # 如果解码后不同，说明原本就是编码的
        if decoded_keyword != keyword:
            keyword = decoded_keyword
    except:
        # 解码失败，使用原始关键词
        pass
    
    # 继续原有的搜索逻辑
    # ...
```

### 方案3：网络超时优化

基于您的文档，已经实现了完善的超时管理机制：

**当前超时配置：**
- 搜索超时：30秒
- 书籍详情超时：45秒  
- 章节目录超时：60秒
- 单章节下载超时：90秒
- 总下载超时：1小时

**建议的网络环境优化：**
```python
# 针对网络不稳定环境的配置调整
POLLING_BASE_TIMEOUT = 60.0      # 增加基础超时
POLLING_MAX_TIMEOUT = 600.0      # 增加最大超时
CIRCUIT_BREAKER_FAILURE_THRESHOLD = 8  # 提高熔断阈值
REQUEST_RETRY_TIMES = 5          # 增加重试次数
```

## 测试验证

### 1. 成功的API调用示例

```bash
# 基础服务检查（✅ 正常）
curl "http://localhost:8000/"

# 书源列表（✅ 正常）
curl "http://localhost:8000/api/novels/sources"

# 正确编码的搜索（✅ 正常）
curl "http://localhost:8000/api/novels/search?keyword=%E6%96%97%E7%A0%B4%E8%8B%8D%E7%A9%B9&maxResults=5"

# 健康检查（✅ 正常，评分80）
curl "http://localhost:8000/api/optimized/health"
```

### 2. 错误的调用方式

```bash
# ❌ 错误：未编码的中文字符
curl "http://localhost:8000/api/novels/search?keyword=斗破苍穹&maxResults=5"
# 结果：Invalid HTTP request received
```

## 立即可用的解决方案

**对于前端应用：**
1. 使用 `encodeURIComponent()` 编码所有中文参数
2. 在发送请求前验证URL格式
3. 添加错误重试机制

**对于API客户端：**
1. 使用 `urllib.parse.quote()` 编码中文参数
2. 实现自动重试和超时处理
3. 使用智能轮询API减少查询频率

**对于命令行工具：**
1. 使用 `curl --data-urlencode` 参数
2. 或手动进行URL编码转换

## 监控建议

1. **启用详细日志**：
```bash
# 查看实时日志
tail -f logs/app.log | grep -E "(错误|失败|超时|Invalid)"
```

2. **监控健康状态**：
```bash
# 定期检查服务健康
curl "http://localhost:8000/api/optimized/health"
```

3. **查看超时统计**：
```bash
# 监控超时情况
curl "http://localhost:8000/api/novels/monitor/timeout"
```

通过实施以上解决方案，您的网络查询失败问题应该得到彻底解决。主要是确保所有包含中文字符的API请求都进行了正确的URL编码。