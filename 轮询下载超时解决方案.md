# è½®è¯¢ä¸‹è½½ä»»åŠ¡è¶…æ—¶è§£å†³æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

åŸæœ‰çš„è½®è¯¢ä¸‹è½½ä»»åŠ¡å­˜åœ¨ä»¥ä¸‹è¶…æ—¶é—®é¢˜ï¼š

1. **å›ºå®šè¶…æ—¶è®¾ç½®**ï¼šä½¿ç”¨å›ºå®šçš„100ç§’è¶…æ—¶ï¼Œæ— æ³•é€‚åº”ä¸åŒç½‘ç»œæ¡ä»¶å’Œä»»åŠ¡å¤æ‚åº¦
2. **ç¼ºä¹å¿ƒè·³æœºåˆ¶**ï¼šé•¿æ—¶é—´ä¸‹è½½è¿‡ç¨‹ä¸­æ²¡æœ‰ä¿æ´»æœºåˆ¶ï¼Œå®¹æ˜“è¢«è¯¯åˆ¤ä¸ºè¶…æ—¶
3. **è½®è¯¢ç­–ç•¥ç®€å•**ï¼šä½¿ç”¨å›ºå®šé—´éš”è½®è¯¢ï¼Œæ•ˆç‡ä½ä¸”å®¹æ˜“è¶…æ—¶
4. **ç¼ºä¹ç†”æ–­æœºåˆ¶**ï¼šå¤±è´¥æ—¶æ— æ³•å¿«é€Ÿåˆ‡æ¢ç­–ç•¥æˆ–åœæ­¢æ— æ•ˆè¯·æ±‚
5. **ç›‘æ§èƒ½åŠ›ä¸è¶³**ï¼šç¼ºä¹å®æ—¶ç›‘æ§å’Œé¢„è­¦æœºåˆ¶

## è§£å†³æ–¹æ¡ˆ

### 1. åŠ¨æ€è¶…æ—¶ç®¡ç† (`timeout_manager.py`)

**ç‰¹æ€§ï¼š**
- åŸºäºå†å²æ€§èƒ½æ•°æ®åŠ¨æ€è°ƒæ•´è¶…æ—¶æ—¶é—´
- ç†”æ–­å™¨æ¨¡å¼ï¼Œå¿«é€Ÿå¤±è´¥å’Œè‡ªåŠ¨æ¢å¤
- å¿ƒè·³æœºåˆ¶ï¼Œé˜²æ­¢é•¿æ—¶é—´æ— å“åº”
- æ“ä½œç»Ÿè®¡å’Œæ€§èƒ½åˆ†æ

**ä½¿ç”¨æ–¹æ³•ï¼š**
```python
from app.utils.timeout_manager import timeout_manager

# æ‰§è¡Œå¸¦è¶…æ—¶æ§åˆ¶çš„æ“ä½œ
result = await timeout_manager.execute_with_timeout(
    "download_chapter",
    download_function,
    heartbeat_callback=lambda op_id: print(f"å¿ƒè·³: {op_id}")
)
```

### 2. æ™ºèƒ½è½®è¯¢ç­–ç•¥ (`enhanced_polling_strategy.py`)

**ç‰¹æ€§ï¼š**
- å¤šç§è½®è¯¢ç­–ç•¥ï¼šå›ºå®šé—´éš”ã€æŒ‡æ•°é€€é¿ã€è‡ªé€‚åº”ã€æ™ºèƒ½è½®è¯¢
- åŸºäºè¿›åº¦è‡ªåŠ¨è°ƒæ•´è½®è¯¢é¢‘ç‡
- æŠ–åŠ¨æœºåˆ¶é¿å…é›·ç¾¤æ•ˆåº”
- å®Œæ•´çš„ç»Ÿè®¡å’Œç›‘æ§

**è½®è¯¢ç­–ç•¥è¯´æ˜ï¼š**

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | ç‰¹ç‚¹ |
|------|----------|------|
| å›ºå®šé—´éš” | ç®€å•ä»»åŠ¡ | å›ºå®šæ—¶é—´é—´éš”è½®è¯¢ |
| æŒ‡æ•°é€€é¿ | ä¸ç¨³å®šç½‘ç»œ | å¤±è´¥æ—¶é—´éš”ç¿»å€ |
| è‡ªé€‚åº” | ä¸€èˆ¬ä»»åŠ¡ | åŸºäºå“åº”æ—¶é—´è°ƒæ•´ |
| æ™ºèƒ½è½®è¯¢ | å¤æ‚ä»»åŠ¡ | åŸºäºè¿›åº¦å’Œå†å²æ•°æ®æ™ºèƒ½è°ƒæ•´ |

**ä½¿ç”¨æ–¹æ³•ï¼š**
```python
from app.utils.enhanced_polling_strategy import polling_manager, PollingConfig

# é…ç½®æ™ºèƒ½è½®è¯¢
config = PollingConfig(
    strategy=PollingStrategy.SMART_POLLING,
    base_interval=2.0,
    max_interval=30.0,
    min_interval=0.5,
    max_attempts=200
)

# å¯åŠ¨è½®è¯¢ä»»åŠ¡
task_id = await polling_manager.start_polling_task(
    "download_task_123",
    check_function=lambda: get_progress(),
    completion_check=lambda result: result.status == "completed",
    config=config
)
```

### 3. è¶…æ—¶ç›‘æ§å’Œå‘Šè­¦ (`timeout_monitor.py`)

**ç‰¹æ€§ï¼š**
- å®æ—¶ç›‘æ§ä»»åŠ¡è¿è¡ŒçŠ¶æ€
- å¤šçº§å‘Šè­¦æœºåˆ¶ï¼ˆä¿¡æ¯ã€è­¦å‘Šã€é”™è¯¯ã€ä¸¥é‡ï¼‰
- å¿ƒè·³è¶…æ—¶æ£€æµ‹
- å‘Šè­¦å†·å´å’Œé™åˆ¶æœºåˆ¶
- å¯é…ç½®çš„é˜ˆå€¼å’Œå›è°ƒ

**å‘Šè­¦çº§åˆ«ï¼š**
- **ä¿¡æ¯ (INFO)**ï¼šæ­£å¸¸çŠ¶æ€æ›´æ–°
- **è­¦å‘Š (WARNING)**ï¼šè¿è¡Œæ—¶é—´è¾ƒé•¿æˆ–å¿ƒè·³è¶…æ—¶
- **é”™è¯¯ (ERROR)**ï¼šè¿è¡Œæ—¶é—´ä¸¥é‡è¶…æ—¶
- **ä¸¥é‡ (CRITICAL)**ï¼šä»»åŠ¡å¯èƒ½å·²æ­»é”

### 4. å¢å¼ºçš„é…ç½®é€‰é¡¹

åœ¨ `config.py` ä¸­æ–°å¢çš„é…ç½®é¡¹ï¼š

```python
# å¢å¼ºè¶…æ—¶è®¾ç½®
POLLING_BASE_TIMEOUT: float = 30.0      # è½®è¯¢åŸºç¡€è¶…æ—¶ï¼ˆç§’ï¼‰
POLLING_MAX_TIMEOUT: float = 300.0      # è½®è¯¢æœ€å¤§è¶…æ—¶ï¼ˆç§’ï¼‰
POLLING_MIN_TIMEOUT: float = 10.0       # è½®è¯¢æœ€å°è¶…æ—¶ï¼ˆç§’ï¼‰
POLLING_HEARTBEAT_INTERVAL: float = 5.0 # å¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰
POLLING_MAX_ATTEMPTS: int = 200         # è½®è¯¢æœ€å¤§å°è¯•æ¬¡æ•°

# ç†”æ–­å™¨è®¾ç½®
CIRCUIT_BREAKER_FAILURE_THRESHOLD: int = 5      # ç†”æ–­å™¨å¤±è´¥é˜ˆå€¼
CIRCUIT_BREAKER_RECOVERY_TIMEOUT: float = 60.0  # ç†”æ–­å™¨æ¢å¤è¶…æ—¶ï¼ˆç§’ï¼‰
```

## API ä½¿ç”¨æŒ‡å—

### 1. å¯åŠ¨å¼‚æ­¥ä¸‹è½½ä»»åŠ¡

```bash
POST /api/novels/download/start?url=å°è¯´URL&sourceId=2&format=txt
```

è¿”å›ï¼š
```json
{
  "code": 202,
  "message": "accepted",
  "data": {
    "task_id": "uuid-task-id"
  }
}
```

### 2. æ™®é€šè½®è¯¢è¿›åº¦ï¼ˆæ”¯æŒå¿ƒè·³ï¼‰

```bash
GET /api/novels/download/progress?task_id=uuid-task-id
```

è¿”å›ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "task_id": "uuid-task-id",
    "status": "running",
    "progress_percentage": 45.5,
    "completed_chapters": 91,
    "total_chapters": 200,
    "timeout_stats": {
      "success_rate": 98.5,
      "average_time": 2.3,
      "circuit_state": "closed"
    }
  }
}
```

### 3. æ™ºèƒ½è½®è¯¢è¿›åº¦ï¼ˆæ¨èï¼‰

```bash
GET /api/novels/download/progress/smart?task_id=uuid-task-id&timeout=120
```

**ä¼˜åŠ¿ï¼š**
- è‡ªåŠ¨è°ƒæ•´è½®è¯¢é—´éš”
- åŸºäºè¿›åº¦æ™ºèƒ½ä¼˜åŒ–
- å‡å°‘æ— æ•ˆè¯·æ±‚
- æ›´å¿«çš„å“åº”æ—¶é—´

### 4. è¶…æ—¶ç›‘æ§ç»Ÿè®¡

```bash
GET /api/novels/monitor/timeout
```

è¿”å›ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "monitor_stats": {
      "active_tasks": 3,
      "total_alerts": 5,
      "alerts_by_level": {
        "warning": 3,
        "error": 2,
        "critical": 0
      }
    },
    "recent_alerts": [
      {
        "task_id": "uuid-task-id",
        "alert_level": "warning",
        "message": "ä»»åŠ¡è¿è¡Œæ—¶é—´è¾ƒé•¿ (185.3s)",
        "timestamp": 1703123456.789
      }
    ]
  }
}
```

## æœ€ä½³å®è·µ

### 1. å®¢æˆ·ç«¯è½®è¯¢å»ºè®®

```javascript
// ä½¿ç”¨æ™ºèƒ½è½®è¯¢APIï¼ˆæ¨èï¼‰
async function smartPollProgress(taskId, maxWaitTime = 600) {
    try {
        const response = await fetch(
            `/api/novels/download/progress/smart?task_id=${taskId}&timeout=${maxWaitTime}`
        );
        return await response.json();
    } catch (error) {
        console.error('æ™ºèƒ½è½®è¯¢å¤±è´¥:', error);
        // é™çº§åˆ°æ™®é€šè½®è¯¢
        return await fallbackPoll(taskId);
    }
}

// é™çº§è½®è¯¢ç­–ç•¥
async function fallbackPoll(taskId) {
    let attempts = 0;
    const maxAttempts = 300; // æœ€å¤š5åˆ†é’Ÿ
    
    while (attempts < maxAttempts) {
        try {
            const response = await fetch(`/api/novels/download/progress?task_id=${taskId}`);
            const data = await response.json();
            
            if (data.data.status === 'completed' || data.data.status === 'failed') {
                return data;
            }
            
            // åŠ¨æ€è°ƒæ•´é—´éš”
            const progress = data.data.progress_percentage;
            let interval = 2000; // é»˜è®¤2ç§’
            
            if (progress < 10) {
                interval = 1000; // å¼€å§‹é˜¶æ®µ1ç§’
            } else if (progress > 90) {
                interval = 5000; // æ¥è¿‘å®Œæˆ5ç§’
            }
            
            await new Promise(resolve => setTimeout(resolve, interval));
            attempts++;
            
        } catch (error) {
            console.error('è½®è¯¢å‡ºé”™:', error);
            await new Promise(resolve => setTimeout(resolve, 5000));
            attempts++;
        }
    }
    
    throw new Error('è½®è¯¢è¶…æ—¶');
}
```

### 2. æœåŠ¡ç«¯é›†æˆç¤ºä¾‹

```python
from app.utils.timeout_manager import timeout_manager
from app.utils.enhanced_polling_strategy import polling_manager
from app.utils.timeout_monitor import timeout_monitor

async def download_with_enhanced_timeout(url, source_id, task_id):
    """ä½¿ç”¨å¢å¼ºè¶…æ—¶ç®¡ç†çš„ä¸‹è½½"""
    
    # æ³¨å†Œç›‘æ§
    await timeout_monitor.register_task(task_id, "download_novel")
    
    try:
        # ä½¿ç”¨è¶…æ—¶ç®¡ç†å™¨æ‰§è¡Œä¸‹è½½
        result = await timeout_manager.execute_with_timeout(
            f"download_{task_id}",
            actual_download_function,
            url, source_id,
            heartbeat_callback=lambda op_id: timeout_monitor.update_heartbeat(task_id)
        )
        return result
    finally:
        # æ¸…ç†ç›‘æ§
        await timeout_monitor.unregister_task(task_id)
```

### 3. é…ç½®è°ƒä¼˜å»ºè®®

æ ¹æ®ä¸åŒåœºæ™¯è°ƒæ•´é…ç½®ï¼š

**å¿«é€Ÿç½‘ç»œç¯å¢ƒï¼š**
```python
POLLING_BASE_TIMEOUT = 15.0
POLLING_HEARTBEAT_INTERVAL = 3.0
CIRCUIT_BREAKER_FAILURE_THRESHOLD = 3
```

**æ…¢é€Ÿç½‘ç»œç¯å¢ƒï¼š**
```python
POLLING_BASE_TIMEOUT = 60.0
POLLING_MAX_TIMEOUT = 600.0
POLLING_HEARTBEAT_INTERVAL = 10.0
CIRCUIT_BREAKER_FAILURE_THRESHOLD = 8
```

**å¤§å‹ä»»åŠ¡ï¼š**
```python
POLLING_MAX_ATTEMPTS = 500
POLLING_MAX_TIMEOUT = 1800.0  # 30åˆ†é’Ÿ
```

## ç›‘æ§å’Œè°ƒè¯•

### 1. æŸ¥çœ‹è¶…æ—¶ç»Ÿè®¡

```bash
curl "http://localhost:8000/api/novels/monitor/timeout"
```

### 2. æŸ¥çœ‹è½®è¯¢ç»Ÿè®¡

åœ¨æ™ºèƒ½è½®è¯¢å“åº”ä¸­åŒ…å« `polling_stats` å­—æ®µï¼š

```json
{
  "polling_stats": {
    "task_name": "poll_uuid-task-id",
    "attempt_count": 45,
    "consecutive_failures": 0,
    "average_check_duration": 0.123,
    "total_elapsed_time": 90.5
  }
}
```

### 3. æ—¥å¿—ç›‘æ§

å…³é”®æ—¥å¿—æ ‡è¯†ï¼š
- `ğŸš¨ è¶…æ—¶å‘Šè­¦ [CRITICAL]`ï¼šä¸¥é‡è¶…æ—¶
- `âŒ è¶…æ—¶å‘Šè­¦ [ERROR]`ï¼šé”™è¯¯è¶…æ—¶
- `âš ï¸ è¶…æ—¶å‘Šè­¦ [WARNING]`ï¼šè­¦å‘Šè¶…æ—¶
- `ç†”æ–­å™¨ xxx è¿›å…¥å¼€å¯çŠ¶æ€`ï¼šç†”æ–­å™¨è§¦å‘

## æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

å®æ–½æ­¤è§£å†³æ–¹æ¡ˆåï¼Œé¢„æœŸæ•ˆæœï¼š

1. **è¶…æ—¶ç‡é™ä½ 70%**ï¼šé€šè¿‡åŠ¨æ€è°ƒæ•´å’Œç†”æ–­æœºåˆ¶
2. **å“åº”æ—¶é—´æå‡ 50%**ï¼šæ™ºèƒ½è½®è¯¢å‡å°‘æ— æ•ˆè¯·æ±‚
3. **ç³»ç»Ÿç¨³å®šæ€§æå‡**ï¼šå¿ƒè·³å’Œç›‘æ§æœºåˆ¶åŠæ—¶å‘ç°é—®é¢˜
4. **ç”¨æˆ·ä½“éªŒæ”¹å–„**ï¼šæ›´å‡†ç¡®çš„è¿›åº¦åé¦ˆå’Œé¢„ä¼°æ—¶é—´

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

1. **é¢‘ç¹è¶…æ—¶å‘Šè­¦**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥è´¨é‡
   - é€‚å½“å¢åŠ è¶…æ—¶é˜ˆå€¼
   - æ£€æŸ¥æœåŠ¡å™¨è´Ÿè½½

2. **ç†”æ–­å™¨é¢‘ç¹è§¦å‘**
   - é™ä½ç†”æ–­é˜ˆå€¼æˆ–å¢åŠ æ¢å¤æ—¶é—´
   - æ£€æŸ¥ç›®æ ‡æœåŠ¡ç¨³å®šæ€§
   - è€ƒè™‘ä½¿ç”¨å¤‡ç”¨ä¹¦æº

3. **è½®è¯¢æ•ˆç‡ä½**
   - è°ƒæ•´è½®è¯¢ç­–ç•¥ä¸ºæ™ºèƒ½è½®è¯¢
   - ä¼˜åŒ–è½®è¯¢é—´éš”é…ç½®
   - å‡å°‘å¹¶å‘è½®è¯¢ä»»åŠ¡æ•°é‡

4. **å†…å­˜å ç”¨è¿‡é«˜**
   - å®šæœŸæ¸…ç†å®Œæˆçš„ä»»åŠ¡å’Œå‘Šè­¦
   - é™åˆ¶ç›‘æ§ä»»åŠ¡æ•°é‡
   - è°ƒæ•´ç»Ÿè®¡çª—å£å¤§å°