# 测试脚本使用说明

本文档说明如何使用提供的测试脚本来验证小说聚合搜索与下载API的各项功能。

## 测试脚本概览

### 1. `comprehensive_test.py` - 综合测试脚本
**功能**: 全面测试所有API功能，包括详细的性能统计和错误诊断
**依赖**: 需要安装 `requests` 库
**适用场景**: 完整的功能验证和性能测试

### 2. `simple_test.py` - 简化测试脚本  
**功能**: 基础功能验证，无外部依赖
**依赖**: 仅使用Python标准库
**适用场景**: 快速验证和环境兼容性检查

## 使用方法

### 前置条件

1. **启动服务**
   ```bash
   # 在项目根目录下启动服务
   python app/main.py
   
   # 或使用uvicorn
   uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
   ```

2. **确认服务运行**
   访问 http://localhost:8000 确认服务正常运行

### 运行综合测试

```bash
# 安装依赖（如果需要）
pip install requests

# 运行综合测试
python comprehensive_test.py
```

**测试内容**:
- ✅ 健康检查和性能统计
- ✅ 书源列表获取
- ✅ 小说搜索功能
- ✅ 书籍详情获取
- ✅ 章节目录获取  
- ✅ 同步下载功能
- ✅ 异步下载功能
- ✅ 下载进度轮询
- ✅ 下载结果获取

### 运行简化测试

```bash
# 无需安装额外依赖，直接运行
python simple_test.py
```

**测试内容**:
- ✅ 服务连通性
- ✅ 健康检查
- ✅ 书源获取
- ✅ 搜索功能
- ✅ 详情获取
- ✅ 目录获取
- ✅ 异步下载启动
- ✅ 轮询功能
- ✅ 结果获取

## 测试流程说明

### 1. 搜索测试
- 使用预设关键词进行搜索
- 验证返回结果的数量和格式
- 提取第一个搜索结果用于后续测试

### 2. 内容获取测试
- 使用搜索结果的URL获取书籍详情
- 验证详情信息的完整性（标题、作者、简介等）
- 获取章节目录并验证章节数量和顺序

### 3. 下载功能测试
- **同步下载**: 直接下载并验证文件流
- **异步下载**: 启动后台任务并返回task_id

### 4. 轮询功能测试
- 使用task_id定期查询下载进度
- 监控任务状态变化 (pending → running → completed)
- 记录轮询次数和进度变化

### 5. 结果获取测试
- 任务完成后获取最终的下载文件
- 验证文件内容和大小
- 检查文件格式正确性

## 测试结果解读

### 成功指标
- ✅ **连通性**: 服务正常响应
- ✅ **搜索**: 能找到相关小说
- ✅ **内容获取**: 能获取完整的书籍信息和目录
- ✅ **下载**: 能成功生成并下载文件
- ✅ **轮询**: 能正确跟踪下载进度

### 常见问题

1. **连接失败**
   - 确认服务是否启动: `curl http://localhost:8000`
   - 检查端口是否被占用: `netstat -tlnp | grep 8000`

2. **搜索无结果**
   - 检查书源配置是否正确
   - 尝试不同的搜索关键词
   - 查看服务日志确认书源可用性

3. **下载失败**
   - 检查网络连接
   - 确认目标网站可访问
   - 查看服务日志获取详细错误信息

4. **轮询超时**
   - 增加轮询次数 (`MAX_POLL_ATTEMPTS`)
   - 检查下载任务是否卡死
   - 查看服务器资源使用情况

## 性能基准

### 预期响应时间
- **搜索**: < 3秒
- **获取详情**: < 2秒  
- **获取目录**: < 5秒
- **启动下载**: < 1秒
- **轮询响应**: < 500ms

### 预期成功率
- **基础功能**: > 95%
- **搜索功能**: > 90%
- **下载功能**: > 85%

## 自定义测试

### 修改测试用例
编辑 `comprehensive_test.py` 中的 `TEST_CASES` 配置:

```python
TEST_CASES = [
    {
        "name": "自定义测试",
        "search_keyword": "你的关键词",
        "expected_results": 1,
        "test_download": True,
        "download_format": "txt"  # 或 "epub"
    }
]
```

### 调整测试参数
```python
# 超时设置
TIMEOUT = 30                # 一般请求超时
DOWNLOAD_TIMEOUT = 300      # 下载超时
MAX_POLL_ATTEMPTS = 60      # 最大轮询次数

# API地址
BASE_URL = "http://localhost:8000"
API_BASE = f"{BASE_URL}/api/optimized"
```

## 故障排除

### 查看详细日志
```bash
# 启动服务时查看日志
python app/main.py

# 或查看特定组件日志
tail -f logs/novel_service.log
```

### 手动API测试
```bash
# 测试健康检查
curl http://localhost:8000/api/optimized/health

# 测试搜索
curl "http://localhost:8000/api/optimized/search?keyword=斗破苍穹"

# 测试书源
curl http://localhost:8000/api/optimized/sources
```

## 注意事项

1. **网络依赖**: 测试需要访问外部小说网站，确保网络连接正常
2. **书源状态**: 某些书源可能临时不可用，这是正常现象
3. **下载时间**: 完整小说下载可能需要较长时间，请耐心等待
4. **资源使用**: 下载测试会消耗一定的网络带宽和存储空间
5. **频率限制**: 避免过于频繁的测试，以免被目标网站限制访问

## 测试报告

测试完成后会生成详细报告，包括:
- 📊 **总体统计**: 成功率、耗时等
- 📋 **详细结果**: 每个测试项的具体情况  
- 🎯 **功能验证**: 各功能模块的工作状态
- 🏆 **最终结论**: 系统整体健康状况

使用这些测试脚本可以全面验证系统的搜索、内容获取、下载和轮询功能是否正常工作。